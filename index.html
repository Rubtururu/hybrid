<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hybrid Raffle & Auction BSC</title>
<script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
<style>
body { font-family: Arial, sans-serif; background: #111; color: #eee; margin:0; padding:0; }
header { background: #222; padding: 20px; text-align: center; font-size: 1.5em; color:#0f0; }
.container { padding: 20px; display:flex; flex-wrap:wrap; gap:20px; justify-content:center;}
.card { background:#222; padding:15px; border-radius:12px; width:300px; box-shadow:0 0 15px #0f0; }
button { padding:10px 15px; margin:5px 0; border:none; border-radius:8px; cursor:pointer; background:#0f0; color:#000; font-weight:bold; }
button:hover { background:#0c0; }
h2 { color:#0f0; }
.stats { margin-top:10px; }
</style>
</head>
<body>

<header>Hybrid Raffle & Auction BSC</header>

<div class="container">
  <div class="card">
    <h2>Conexión</h2>
    <p id="account">Cuenta: No conectada</p>
    <button id="connectBtn">Conectar Metamask</button>
  </div>

  <div class="card">
    <h2>Rifa Horaria</h2>
    <p>Prize pool: <span id="raffleHourlyPrize">0</span> BNB</p>
    <p>Participantes: <span id="raffleHourlyParticipants">0</span></p>
    <p>Fin en: <span id="raffleHourlyCountdown">--:--:--</span></p>
    <button onclick="buyTicket(1)">Comprar 1 Ticket (0.001 BNB)</button>
    <button onclick="buyTicket(5)">Comprar 5 Tickets (0.004 BNB)</button>
    <button onclick="buyTicket(10)">Comprar 10 Tickets (0.007 BNB)</button>
  </div>

  <div class="card">
    <h2>Rifa Diaria</h2>
    <p>Prize pool: <span id="raffleDailyPrize">0</span> BNB</p>
    <p>Participantes: <span id="raffleDailyParticipants">0</span></p>
    <p>Fin en: <span id="raffleDailyCountdown">--:--:--</span></p>
  </div>

  <div class="card">
    <h2>Subasta</h2>
    <p>Precio actual: <span id="auctionPrice">0</span> BNB</p>
    <p>Fin en: <span id="auctionCountdown">--:--:--</span></p>
    <button onclick="placeBid()">Pujar</button>
  </div>

  <div class="card">
    <h2>Staking</h2>
    <input type="number" id="stakeAmount" placeholder="BNB a stakear">
    <button onclick="stake()">Stake</button>
    <input type="number" id="unstakeAmount" placeholder="BNB a retirar">
    <button onclick="unstake()">Retirar Stake</button>
  </div>

  <div class="card">
    <h2>Ganancias</h2>
    <p>Balance disponible: <span id="myEarnings">0</span> BNB</p>
    <button onclick="withdrawEarnings()">Retirar Ganancias</button>
  </div>

  <div class="card">
    <h2>Estadísticas</h2>
    <div class="stats">
      <p>Total rifas: <span id="totalRaffles">0</span></p>
      <p>Total subastas: <span id="totalAuctions">0</span></p>
    </div>
  </div>
</div>

<script>
let web3;
let contract;
let account;
const contractAddress = "0x7407D7E91f2e341457Bf1C791F0a37fB144aeddc";
const abi = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"auctions","outputs":[{"internalType":"uint128","name":"prizeGuaranteed","type":"uint128"},{"internalType":"uint128","name":"prizeCurrent","type":"uint128"},{"internalType":"uint128","name":"currentBid","type":"uint128"},{"internalType":"uint64","name":"endTime","type":"uint64"},{"internalType":"bool","name":"active","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"auctionsCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"balance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"bid","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint8","name":"numTickets","type":"uint8"}],"name":"buyTickets","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"closeAuction","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"index","type":"uint256"}],"name":"closeRaffle","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"feeOwnerPercent","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"index","type":"uint256"}],"name":"getAuction","outputs":[{"internalType":"uint128","name":"","type":"uint128"},{"internalType":"uint128","name":"","type":"uint128"},{"internalType":"uint128","name":"","type":"uint128"},{"internalType":"uint64","name":"","type":"uint64"},{"internalType":"address[]","name":"","type":"address[]"},{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"index","type":"uint256"}],"name":"getRaffle","outputs":[{"internalType":"uint128","name":"","type":"uint128"},{"internalType":"uint128","name":"","type":"uint128"},{"internalType":"uint64","name":"","type":"uint64"},{"internalType":"uint8","name":"","type":"uint8"},{"internalType":"bool","name":"","type":"bool"},{"internalType":"address[]","name":"","type":"address[]"},{"internalType":"address[]","name":"","type":"address[]"},{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"pendingWithdrawals","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"raffles","outputs":[{"internalType":"uint128","name":"prizeGuaranteed","type":"uint128"},{"internalType":"uint128","name":"prizeCurrent","type":"uint128"},{"internalType":"uint64","name":"endTime","type":"uint64"},{"internalType":"uint8","name":"winnersCount","type":"uint8"},{"internalType":"bool","name":"isDaily","type":"bool"},{"internalType":"bool","name":"closed","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"rafflesCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"reserveMinPercent","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"stakeTokens","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"staked","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"tickets","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"withdrawStake","outputs":[],"stateMutability":"nonpayable","type":"function"}];

async function connectWallet(){
    if(window.ethereum){
        web3 = new Web3(window.ethereum);
        await window.ethereum.enable();
        const accounts = await web3.eth.getAccounts();
        account = accounts[0];
        document.getElementById("account").innerText = "Cuenta: "+account;
        contract = new web3.eth.Contract(abi, contractAddress);
        updateUI();
        setInterval(updateUI,5000); // refresco cada 5s
    } else {
        alert("Instala Metamask para interactuar");
    }
}

async function updateUI(){
    if(!contract) return;
    const rafflesCount = await contract.methods.rafflesCount().call();
    const auctionsCount = await contract.methods.auctionsCount().call();
    document.getElementById("totalRaffles").innerText = rafflesCount;
    document.getElementById("totalAuctions").innerText = auctionsCount;

    // Rifas
    for(let i=rafflesCount-1;i>=0;i--){
        let r = await contract.methods.getRaffle(i).call();
        if(!r[7]){ // si no está cerrada
            if(!r[4]){ // horaria
                document.getElementById("raffleHourlyPrize").innerText = web3.utils.fromWei(r[1]);
                document.getElementById("raffleHourlyParticipants").innerText = r[5].length;
                document.getElementById("raffleHourlyCountdown").innerText = getCountdown(r[2]);
            } else { // diaria
                document.getElementById("raffleDailyPrize").innerText = web3.utils.fromWei(r[1]);
                document.getElementById("raffleDailyParticipants").innerText = r[5].length;
                document.getElementById("raffleDailyCountdown").innerText = getCountdown(r[2]);
            }
        }
    }

    // Subasta
    const auctionsLen = await contract.methods.auctionsCount().call();
    if(auctionsLen>0){
        const a = await contract.methods.getAuction(auctionsLen-1).call();
        if(a[5]){
            document.getElementById("auctionPrice").innerText = web3.utils.fromWei(a[2]);
            document.getElementById("auctionCountdown").innerText = getCountdown(a[3]);
        }
    }

    // Ganancias
    const pending = await contract.methods.pendingWithdrawals(account).call();
    document.getElementById("myEarnings").innerText = web3.utils.fromWei(pending);
}

function getCountdown(timestamp){
    const now = Math.floor(Date.now()/1000);
    let diff = timestamp - now;
    if(diff<0) diff=0;
    const h = Math.floor(diff/3600);
    const m = Math.floor((diff%3600)/60);
    const s = diff%60;
    return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
}

// Compras de tickets
async function buyTicket(num){
    let price = num==1? "1000000000000000" : num==5?"4000000000000000":"7000000000000000";
    try{
        await contract.methods.buyTickets(num).send({from:account,value:price});
        alert("Ticket comprado!");
        updateUI();
    }catch(e){ console.error(e); alert("Error al comprar ticket");}
}

// Pujar
async function placeBid(){
    try{
        await contract.methods.bid().send({from:account,value:web3.utils.toWei("0.001","ether")}); 
        alert("Puja realizada!");
        updateUI();
    }catch(e){ console.error(e); alert("Error al pujar");}
}

// Staking
async function stake(){
    const val = document.getElementById("stakeAmount").value;
    if(!val || val<=0) return alert("Introduce cantidad valida");
    try{
        await contract.methods.stakeTokens().send({from:account,value:web3.utils.toWei(val,"ether")});
        alert("Stake realizado!");
        updateUI();
    }catch(e){ console.error(e); alert("Error al stakear");}
}

async function unstake(){
    const val = document.getElementById("unstakeAmount").value;
    if(!val || val<=0) return alert("Introduce cantidad valida");
    try{
        await contract.methods.withdrawStake(web3.utils.toWei(val,"ether")).send({from:account});
        alert("Stake retirado!");
        updateUI();
    }catch(e){ console.error(e); alert("Error al retirar stake");}
}

// Retirar ganancias
async function withdrawEarnings(){
    try{
        await contract.methods.withdraw().send({from:account});
        alert("Ganancias retiradas!");
        updateUI();
    }catch(e){ console.error(e); alert("Error al retirar ganancias");}
}

// Botón conexión
document.getElementById("connectBtn").addEventListener("click",connectWallet);
</script>

</body>
</html>
