<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hybrid Raffle & Auction BSC</title>
<style>
    /* ---------------- Global ---------------- */
    body { font-family: 'Poppins', sans-serif; background: linear-gradient(to right, #1e3c72, #2a5298); color: #fff; margin:0; padding:0;}
    h1,h2,h3 { margin: 0; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    button { cursor:pointer; border:none; border-radius:12px; padding:10px 20px; font-weight:bold; transition:all 0.2s; }
    button:hover { transform: scale(1.05); }

    /* ---------------- Header ---------------- */
    header { display:flex; justify-content: space-between; align-items:center; padding:20px; background: rgba(0,0,0,0.3); border-radius: 0 0 20px 20px; margin-bottom:20px; }
    .wallet-btn { background: #ff9800; color:#000; }

    /* ---------------- Sections ---------------- */
    .card { background: rgba(255,255,255,0.1); padding:20px; border-radius:20px; margin-bottom:20px; box-shadow: 0 8px 20px rgba(0,0,0,0.3);}
    .card h2 { margin-bottom:10px; }
    .section { display:flex; flex-wrap: wrap; gap:20px; }

    /* ---------------- Prize & Countdown ---------------- */
    .prize { font-size:1.2em; font-weight:bold; margin:10px 0; }
    .countdown { font-size:1.1em; color:#ffeb3b; margin-bottom:10px; }

    /* ---------------- Inputs ---------------- */
    input[type=number] { padding:8px; border-radius:8px; border:none; width:60px; margin-right:10px; }

    /* ---------------- Tables ---------------- */
    table { width:100%; border-collapse: collapse; margin-top:10px;}
    th,td { padding:8px; text-align:left; border-bottom:1px solid rgba(255,255,255,0.2); }
</style>
</head>
<body>
<div class="container">

    <header>
        <h1>Hybrid Raffle & Auction BSC</h1>
        <button class="wallet-btn" id="connectWallet">Conectar Wallet</button>
    </header>

    <!-- ---------------- Rifas ---------------- -->
    <div class="card">
        <h2>Rifa Horaria</h2>
        <div class="prize">Prize Pool: <span id="hourlyPrize">0</span> BNB</div>
        <div class="countdown">Tiempo restante: <span id="hourlyCountdown">00:00:00</span></div>
        <input type="number" id="hourlyTickets" value="1" min="1">
        <button id="buyHourly">Comprar Tickets</button>
        <h3>Participantes:</h3>
        <ul id="hourlyParticipants"></ul>
    </div>

    <div class="card">
        <h2>Rifa Diaria</h2>
        <div class="prize">Prize Pool: <span id="dailyPrize">0</span> BNB</div>
        <div class="countdown">Tiempo restante: <span id="dailyCountdown">00:00:00</span></div>
        <input type="number" id="dailyTickets" value="1" min="1">
        <button id="buyDaily">Comprar Tickets</button>
        <h3>Participantes:</h3>
        <ul id="dailyParticipants"></ul>
    </div>

    <!-- ---------------- Subasta ---------------- -->
    <div class="card">
        <h2>Subasta Activa</h2>
        <div class="prize">Prize Pool: <span id="auctionPrize">0</span> BNB</div>
        <div class="countdown">Tiempo restante: <span id="auctionCountdown">00:00:00</span></div>
        <input type="number" id="bidAmount" value="1" min="0.01" step="0.01">
        <button id="placeBid">Pujar</button>
        <h3>Últimos 10 pujadores:</h3>
        <ul id="lastBidders"></ul>
    </div>

    <!-- ---------------- Staking ---------------- -->
    <div class="card">
        <h2>Staking</h2>
        <div>Tu Stake: <span id="userStake">0</span> BNB</div>
        <input type="number" id="stakeAmount" value="0.1" min="0.01" step="0.01">
        <button id="stakeBtn">Stake</button>
        <button id="withdrawBtn">Retirar</button>
    </div>

    <!-- ---------------- Estadísticas ---------------- -->
    <div class="card">
        <h2>Estadísticas</h2>
        <p>Balance del contrato: <span id="contractBalance">0</span> BNB</p>
        <p>Total tickets comprados: <span id="totalTickets">0</span></p>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
<script>
let web3;
let contract;
let accounts = [];

const contractAddress = "0xC2DACb77E617cacfC8d6640274693c57f38e07bf";
const abi = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"auctions","outputs":[{"internalType":"uint128","name":"prizeGuaranteed","type":"uint128"},{"internalType":"uint128","name":"prizeCurrent","type":"uint128"},{"internalType":"uint128","name":"currentBid","type":"uint128"},{"internalType":"uint64","name":"endTime","type":"uint64"},{"internalType":"bool","name":"active","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"auctionsCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"balance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"bid","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"numTickets","type":"uint256"}],"name":"buyTickets","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"closeAuction","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"index","type":"uint256"}],"name":"closeRaffle","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"feeOwnerPercent","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"index","type":"uint256"}],"name":"getAuction","outputs":[{"internalType":"uint128","name":"","type":"uint128"},{"internalType":"uint128","name":"","type":"uint128"},{"internalType":"uint128","name":"","type":"uint128"},{"internalType":"uint64","name":"","type":"uint64"},{"internalType":"address[]","name":"","type":"address[]"},{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"index","type":"uint256"}],"name":"getRaffle","outputs":[{"internalType":"uint128","name":"","type":"uint128"},{"internalType":"uint128","name":"","type":"uint128"},{"internalType":"uint64","name":"","type":"uint64"},{"internalType":"uint8","name":"","type":"uint8"},{"internalType":"bool","name":"","type":"bool"},{"internalType":"address[]","name":"","type":"address[]"},{"internalType":"address[]","name":"","type":"address[]"},{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"nonce","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"raffles","outputs":[{"internalType":"uint128","name":"prizeGuaranteed","type":"uint128"},{"internalType":"uint128","name":"prizeCurrent","type":"uint128"},{"internalType":"uint64","name":"endTime","type":"uint64"},{"internalType":"uint8","name":"winnersCount","type":"uint8"},{"internalType":"bool","name":"isDaily","type":"bool"},{"internalType":"bool","name":"closed","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"rafflesCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"reserveMinPercent","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"stakeTokens","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"staked","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"tickets","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"withdrawStake","outputs":[],"stateMutability":"nonpayable","type":"function"}];

// -------- Conectar Wallet --------
document.getElementById("connectWallet").onclick = async () => {
    if(window.ethereum){
        await window.ethereum.request({ method: "eth_requestAccounts" });
        web3 = new Web3(window.ethereum);
        accounts = await web3.eth.getAccounts();
        contract = new web3.eth.Contract(abi, contractAddress);
        alert("Wallet conectada: " + accounts[0]);
        loadAllData();
    } else alert("Instala MetaMask o TrustWallet!");
};

// -------- Funciones --------
async function loadAllData(){
    loadRaffle(true);   // diaria
    loadRaffle(false);  // horaria
    loadAuction();
    loadStats();
}

async function loadRaffle(isDaily){
    let count = await contract.methods.rafflesCount().call();
    for(let i=count-1;i>=0;i--){
        let r = await contract.methods.getRaffle(i).call();
        if(r[4] == isDaily && !r[7]){
            const prize = web3.utils.fromWei(r[1].toString(), "ether");
            const endTime = parseInt(r[2]);
            const participants = r[5];
            if(isDaily){
                document.getElementById("dailyPrize").innerText = prize;
                document.getElementById("dailyParticipants").innerHTML = participants.map(a => "<li>"+a+"</li>").join("");
                startCountdown(endTime,"dailyCountdown");
            } else {
                document.getElementById("hourlyPrize").innerText = prize;
                document.getElementById("hourlyParticipants").innerHTML = participants.map(a => "<li>"+a+"</li>").join("");
                startCountdown(endTime,"hourlyCountdown");
            }
            break;
        }
    }
}

async function loadAuction(){
    let count = await contract.methods.auctionsCount().call();
    if(count==0) return;
    let a = await contract.methods.getAuction(count-1).call();
    if(a[5]){ // activa
        const prize = web3.utils.fromWei(a[1].toString(),"ether");
        const endTime = parseInt(a[3]);
        const bidders = a[4];
        document.getElementById("auctionPrize").innerText = prize;
        document.getElementById("lastBidders").innerHTML = bidders.map(b=>"<li>"+b+"</li>").join("");
        startCountdown(endTime,"auctionCountdown");
    }
}

async function loadStats(){
    let bal = await web3.eth.getBalance(contractAddress);
    document.getElementById("contractBalance").innerText = web3.utils.fromWei(bal.toString(),"ether");
    // Total tickets
    // opcional: sumar manualmente si quieres
}

// -------- Countdown --------
function startCountdown(endTime,elemId){
    function update(){
        const now = Math.floor(Date.now()/1000);
        let diff = endTime - now;
        if(diff<0) diff=0;
        const h = Math.floor(diff/3600);
        const m = Math.floor((diff%3600)/60);
        const s = diff%60;
        document.getElementById(elemId).innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        if(diff>0) requestAnimationFrame(update);
    }
    update();
}

// -------- Comprar Tickets --------
document.getElementById("buyHourly").onclick = async () => { await buyTickets(false); }
document.getElementById("buyDaily").onclick = async () => { await buyTickets(true); }

async function buyTickets(isDaily){
    let num = isDaily ? parseInt(document.getElementById("dailyTickets").value) : parseInt(document.getElementById("hourlyTickets").value);
    let priceWei;
    if(num==1) priceWei = web3.utils.toWei("1","ether");
    else if(num==5) priceWei = web3.utils.toWei("4","ether");
    else if(num>=10) priceWei = web3.utils.toWei("7","ether");
    else priceWei = web3.utils.toWei(num.toString(),"ether");
    await contract.methods.buyTickets(num).send({from:accounts[0], value:priceWei});
    loadAllData();
}

// -------- Pujar --------
document.getElementById("placeBid").onclick = async () => {
    let val = parseFloat(document.getElementById("bidAmount").value);
    let valueWei = web3.utils.toWei(val.toString(),"ether");
    await contract.methods.bid().send({from:accounts[0], value:valueWei});
    loadAllData();
}

// -------- Stake / Withdraw --------
document.getElementById("stakeBtn").onclick = async ()=>{
    let val = parseFloat(document.getElementById("stakeAmount").value);
    await contract.methods.stakeTokens().send({from:accounts[0], value:web3.utils.toWei(val.toString(),"ether")});
    loadAllData();
}
document.getElementById("withdrawBtn").onclick = async ()=>{
    let val = parseFloat(document.getElementById("stakeAmount").value);
    await contract.methods.withdrawStake(web3.utils.toWei(val.toString(),"ether")).send({from:accounts[0]});
    loadAllData();
}

</script>
</body>
</html>
