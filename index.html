<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hybrid Raffle & Auction Premium</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/web3/dist/web3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* ==== RESET ==== */
*{margin:0;padding:0;box-sizing:border-box;font-family:'Roboto',sans-serif;}
body{background: linear-gradient(135deg,#1e1f2f,#292b42);color:#fff;}
h2{color:#ffd700;margin-bottom:10px;}
button{cursor:pointer;border:none;border-radius:10px;padding:10px 20px;font-weight:bold;transition:0.3s;}
button:hover{opacity:0.85;}
.section{padding:20px;margin:20px auto;max-width:1200px;background:rgba(255,255,255,0.05);border-radius:15px;box-shadow:0 0 15px rgba(0,0,0,0.5);}
.flex{display:flex;gap:20px;flex-wrap:wrap;}
.card{background:rgba(0,0,0,0.3);border-radius:15px;padding:15px;flex:1 1 300px;position:relative;animation:fadeIn 1s ease;}
.card h3{margin-bottom:10px;color:#00e676;}
.stat{font-size:14px;margin:5px 0;}
.participants,.winners,.bidders,.history,.ranking{max-height:150px;overflow-y:auto;margin-top:10px;background:rgba(0,0,0,0.2);padding:10px;border-radius:10px;}
.countdown{font-size:20px;font-weight:bold;color:#ff3d00;}
.btn-primary{background:#ff3d00;color:#fff;}
.btn-secondary{background:#00b0ff;color:#fff;}
.btn-stake{background:#00e676;color:#000;}
.chart-container{position:relative;width:100%;height:300px;margin-top:20px;}
input[type=number]{padding:5px;border-radius:5px;border:none;width:100px;}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
</style>
</head>
<body>

<!-- HEADER -->
<div class="section flex" style="justify-content:space-between;align-items:center;">
  <h2>Hybrid Raffle & Auction Premium</h2>
  <button id="connectWallet" class="btn-primary"><span class="material-icons">account_balance_wallet</span> Conectar Wallet</button>
  <span id="userAddress"></span>
</div>

<!-- ESTADÍSTICAS GLOBALES -->
<div class="section">
<h2>Estadísticas Globales</h2>
<div class="flex">
  <div class="card"><h3>BNB Recaudado</h3><div class="stat" id="totalBNB">0</div></div>
  <div class="card"><h3>Total Tickets Vendidos</h3><div class="stat" id="totalTickets">0</div></div>
  <div class="card"><h3>Total Usuarios</h3><div class="stat" id="totalUsuarios">0</div></div>
</div>
<div class="chart-container"><canvas id="bnbChart"></canvas></div>
</div>

<!-- RIFA HORARIA -->
<div class="section">
<h2>Rifa Horaria</h2>
<div class="flex">
<div class="card">
  <h3>Prize Pool</h3><div class="stat" id="hourlyPrize">0 BNB</div>
  <div class="countdown" id="hourlyCountdown">Cargando...</div>
  <div class="participants" id="hourlyParticipants"></div>
  <div class="winners" id="hourlyWinners"></div>
  <input type="number" id="hourlyTickets" placeholder="Tickets a usar">
  <button class="btn-primary" onclick="useTickets(true)">Usar Tickets</button>
</div>
</div>
</div>

<!-- RIFA DIARIA -->
<div class="section">
<h2>Rifa Diaria</h2>
<div class="flex">
<div class="card">
  <h3>Prize Pool</h3><div class="stat" id="dailyPrize">0 BNB</div>
  <div class="countdown" id="dailyCountdown">Cargando...</div>
  <div class="participants" id="dailyParticipants"></div>
  <div class="winners" id="dailyWinners"></div>
  <input type="number" id="dailyTickets" placeholder="Tickets a usar">
  <button class="btn-primary" onclick="useTickets(false)">Usar Tickets</button>
</div>
</div>
</div>

<!-- SUBASTA -->
<div class="section">
<h2>Subasta</h2>
<div class="flex">
<div class="card">
  <h3>Prize Pool</h3><div class="stat" id="auctionPrize">0 BNB</div>
  <div class="countdown" id="auctionCountdown">Cargando...</div>
  <div class="bidders" id="auctionBidders"></div>
  <button class="btn-primary" onclick="placeBid()">Pujar</button>
</div>
</div>
</div>

<!-- STAKING -->
<div class="section">
<h2>Staking</h2>
<div class="flex">
<div class="card">
  <h3>BNB Staked</h3><div class="stat" id="stakedBNB">0</div>
  <div class="stat">Tickets Generados: <span id="stakingTickets">0</span></div>
  <input type="number" id="stakeAmount" placeholder="BNB a stakear">
  <button class="btn-stake" onclick="stake()">Stake</button>
  <button class="btn-stake" onclick="unstake()">Unstake</button>
</div>
</div>
</div>

<!-- HISTORIAL Y RANKINGS -->
<div class="section">
<h2>Historial Rifas y Subasta</h2>
<div class="flex">
<div class="card">
<h3>Historial Rifas</h3>
<div class="history" id="raffleHistory"></div>
</div>
<div class="card">
<h3>Historial Subasta</h3>
<div class="history" id="auctionHistory"></div>
</div>
<div class="card">
<h3>Ranking Usuarios</h3>
<div class="ranking" id="rankingUsers"></div>
</div>
</div>
</div>

<!-- GRÁFICOS -->
<div class="section">
<h2>Gráficos Avanzados</h2>
<div class="chart-container"><canvas id="ticketsChart"></canvas></div>
<div class="chart-container"><canvas id="prizePoolChart"></canvas></div>
</div>

<script>
let web3, contract, userAddress;
const contractAddress="0x1A7555635e049631744AD31Ca7b55CD439F3D7B9";
const contractABI=[{"inputs":[{"internalType":"address","name":"_treasury","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[],"name":"AUCTION_INCREMENT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"AUCTION_START","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"FEE_OWNER","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"FEE_TREASURY","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"STAKE_UNIT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"TICKET_1","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"TICKET_10","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"TICKET_5","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"auction","outputs":[{"internalType":"uint256","name":"prize","type":"uint256"},{"internalType":"uint256","name":"currentBid","type":"uint256"},{"internalType":"uint256","name":"endTime","type":"uint256"},{"internalType":"bool","name":"active","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"auctionHistory","outputs":[{"internalType":"uint256","name":"prize","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"bid","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"bnbGanadoRifas","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"bnbGanadoSubastas","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint8","name":"pack","type":"uint8"}],"name":"buyTickets","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"closeAuction","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bool","name":"daily","type":"bool"}],"name":"closeRaffle","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"knownUser","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"lastStakeClaim","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"pendingWithdraw","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"raffleDaily","outputs":[{"internalType":"bool","name":"isDaily","type":"bool"},{"internalType":"uint256","name":"prize","type":"uint256"},{"internalType":"uint256","name":"endTime","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"raffleHistory","outputs":[{"internalType":"uint256","name":"prize","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"raffleHourly","outputs":[{"internalType":"bool","name":"isDaily","type":"bool"},{"internalType":"uint256","name":"prize","type":"uint256"},{"internalType":"uint256","name":"endTime","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"stake","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"stakedBNB","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"stakingFeesPaid","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"ticketsComprados","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"ticketsGastados","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"ticketsStaking","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalBNBRecaudado","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalBNBRepartidoRifas","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalBNBRepartidoSubastas","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalBNBStaked","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalTicketsVendidos","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalUsuarios","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"treasury","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"bool","name":"daily","type":"bool"}],"name":"useTickets","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"}];

async function connectWallet(){
  if(window.ethereum){
    try{
      await window.ethereum.request({method:"eth_requestAccounts"});
      web3=new Web3(window.ethereum);
      const accounts = await web3.eth.getAccounts();
      userAddress = accounts[0];
      document.getElementById("userAddress").innerText=userAddress;
      contract=new web3.eth.Contract(contractABI,contractAddress);
      loadAll();
    }catch(err){alert("Error conectando wallet: "+err.message);}
  }else alert("MetaMask no detectado");
}
document.getElementById("connectWallet").addEventListener("click",connectWallet);

async function loadAll(){
  await updateStats(); await updateRaffles(); await updateAuction();
  await updateStaking(); await updateHistory(); await updateRanking();
  setInterval(()=>{updateCountdowns(); updateStats(); updateRaffles(); updateAuction(); updateStaking();},1000);
}

// ====== FUNCIONES ACTUALIZACION ======
async function updateStats(){
  const totalBNB = await contract.methods.totalBNBRecaudado().call();
  const totalTickets = await contract.methods.totalTicketsVendidos().call();
  const totalUsuarios = await contract.methods.totalUsuarios().call();
  document.getElementById("totalBNB").innerText=web3.utils.fromWei(totalBNB,"ether")+" BNB";
  document.getElementById("totalTickets").innerText=totalTickets;
  document.getElementById("totalUsuarios").innerText=totalUsuarios;

  // Chart BNB
  const ctx = document.getElementById("bnbChart").getContext("2d");
  if(window.bnbChart) window.bnbChart.destroy();
  window.bnbChart = new Chart(ctx,{type:'bar',data:{labels:['BNB Recaudado'],datasets:[{label:'BNB',data:[parseFloat(web3.utils.fromWei(totalBNB,"ether"))],backgroundColor:'#ff3d00'}]},options:{responsive:true,plugins:{legend:{display:false}}}});
}

async function updateRaffles(){
  const raffleH = await contract.methods.raffleHourly().call();
  const raffleD = await contract.methods.raffleDaily().call();
  document.getElementById("hourlyPrize").innerText=web3.utils.fromWei(raffleH.prize,"ether")+" BNB";
  document.getElementById("dailyPrize").innerText=web3.utils.fromWei(raffleD.prize,"ether")+" BNB";
  document.getElementById("hourlyParticipants").innerHTML="<b>Participantes:</b><br>"+raffleH.participants.join("<br>");
  document.getElementById("dailyParticipants").innerHTML="<b>Participantes:</b><br>"+raffleD.participants.join("<br>");
  document.getElementById("hourlyWinners").innerHTML="<b>Ganadores:</b><br>"+raffleH.winners.join("<br>");
  document.getElementById("dailyWinners").innerHTML="<b>Ganadores:</b><br>"+raffleD.winners.join("<br>");
}

async function updateAuction(){
  const a = await contract.methods.auction().call();
  document.getElementById("auctionPrize").innerText=web3.utils.fromWei(a.prize,"ether")+" BNB";
  document.getElementById("auctionBidders").innerHTML="<b>Últimos pujadores:</b><br>"+a.lastBidders.join("<br>");
}

async function updateStaking(){
  const staked = await contract.methods.stakedBNB(userAddress).call();
  const tickets = await contract.methods.ticketsStaking(userAddress).call();
  document.getElementById("stakedBNB").innerText=web3.utils.fromWei(staked,"ether")+" BNB";
  document.getElementById("stakingTickets").innerText=tickets;
}

async function updateCountdowns(){
  const now = Math.floor(Date.now()/1000);
  const raffleH = await contract.methods.raffleHourly().call();
  const raffleD = await contract.methods.raffleDaily().call();
  const a = await contract.methods.auction().call();
  document.getElementById("hourlyCountdown").innerText=secondsToTime(raffleH.endTime-now);
  document.getElementById("dailyCountdown").innerText=secondsToTime(raffleD.endTime-now);
  document.getElementById("auctionCountdown").innerText=secondsToTime(a.endTime-now);
}

function secondsToTime(secs){
  if(secs<0) return "00:00:00";
  const h=Math.floor(secs/3600),m=Math.floor((secs%3600)/60),s=secs%60;
  return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
}

// ====== FUNCIONES DE USO ======
async function useTickets(daily){
  const input = daily ? document.getElementById("hourlyTickets").value : document.getElementById("dailyTickets").value;
  const amount = parseInt(input);
  if(amount>0){
    await contract.methods.useTickets(amount,daily).send({from:userAddress});
    loadAll();
  }
}

async function placeBid(){
  const a = await contract.methods.auction().call();
  const bidAmount = a.currentBid==0?web3.utils.toWei("0.001","ether"):web3.utils.toWei((parseFloat(web3.utils.fromWei(a.currentBid,"ether"))+0.001).toString(),"ether");
  await contract.methods.bid().send({from:userAddress,value:bidAmount});
  loadAll();
}

async function stake(){
  const val = document.getElementById("stakeAmount").value;
  if(val>0){
    await contract.methods.stake().send({from:userAddress,value:web3.utils.toWei(val,"ether")});
    loadAll();
  }
}

async function unstake(){
  alert("Función de unstake pendiente en contrato.");
}

async function updateHistory(){
  const raffleH = await contract.methods.raffleHistory().call();
  const auctionH = await contract.methods.auctionHistory().call();
  document.getElementById("raffleHistory").innerHTML = raffleH.map(r=>`<b>Prize:</b> ${web3.utils.fromWei(r.prize,'ether')} BNB - Winners: ${r.winners.join(', ')}<br>`).join('');
  document.getElementById("auctionHistory").innerHTML = auctionH.map(a=>`<b>Prize:</b> ${web3.utils.fromWei(a.prize,'ether')} BNB - Winners: ${a.winners.join(', ')}<br>`).join('');
}

async function updateRanking(){
  // Ejemplo: ranking por BNB ganado rifas+subastas
  const users = await contract.methods.getAllUsers().call(); // O una función que tengas en contrato
  const ranking = [];
  for(const u of users){
    const r = parseFloat(web3.utils.fromWei(await contract.methods.bnbGanadoRifas(u).call(),'ether'));
    const s = parseFloat(web3.utils.fromWei(await contract.methods.bnbGanadoSubastas(u).call(),'ether'));
    ranking.push({address:u,total:r+s});
  }
  ranking.sort((a,b)=>b.total-a.total);
  document.getElementById("rankingUsers").innerHTML = ranking.map((r,i)=>`${i+1}. ${r.address} - ${r.total.toFixed(4)} BNB`).join("<br>");
}
</script>

</body>
</html>
