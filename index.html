<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hybrid Raffle & Auction</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/web3@1.8.1/dist/web3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: 'Arial', sans-serif; background: linear-gradient(to right, #6a11cb, #2575fc); color: #fff; margin:0; padding:0; }
.container { max-width: 1200px; margin: auto; padding: 20px; }
.card { background: rgba(255,255,255,0.1); border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 0 20px rgba(0,0,0,0.3); transition: transform 0.3s; }
.card:hover { transform: scale(1.02); }
h2 { color: #fff; }
button { background-color: #ff4081; border: none; padding: 10px 20px; border-radius: 10px; color: #fff; cursor: pointer; font-weight: bold; margin: 5px; transition: 0.3s; }
button:hover { background-color: #e91e63; transform: scale(1.05); }
.stats { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 10px; }
.stat-box { background: rgba(0,0,0,0.3); padding: 10px; border-radius: 10px; flex: 1; min-width: 150px; text-align: center; }
.participants, .winners, .ranking { max-height: 150px; overflow-y: auto; margin-top: 10px; }
.participants div, .winners div, .ranking div { padding: 5px; border-bottom: 1px solid rgba(255,255,255,0.2); display: flex; justify-content: space-between; }
</style>
</head>
<body>
<div class="container">
<h1>Hybrid Raffle & Auction</h1>
<button id="connectWalletBtn">Conectar Wallet</button>
<div id="walletAddress"></div>

<div class="stats">
<div class="stat-box">Total BNB Recaudado:<br><span id="totalBNB">0</span></div>
<div class="stat-box">Total Tickets Vendidos:<br><span id="totalTickets">0</span></div>
<div class="stat-box">Tickets Disponibles:<br><span id="myTickets">0</span></div>
</div>

<!-- Rifa Horaria -->
<div class="card" id="hourlyRaffleCard">
<h2>Rifa Horaria</h2>
<div>Prize Pool: <span id="hourlyPrize">0</span> BNB</div>
<div>Tiempo restante: <span id="hourlyTimer">00:00:00</span></div>
<div class="participants" id="hourlyParticipants"></div>
<div class="winners" id="hourlyWinners"></div>
<button onclick="useTicketsRaffle(false)">Usar Tickets</button>
</div>

<!-- Rifa Diaria -->
<div class="card" id="dailyRaffleCard">
<h2>Rifa Diaria</h2>
<div>Prize Pool: <span id="dailyPrize">0</span> BNB</div>
<div>Tiempo restante: <span id="dailyTimer">00:00:00</span></div>
<div class="participants" id="dailyParticipants"></div>
<div class="winners" id="dailyWinners"></div>
<button onclick="useTicketsRaffle(true)">Usar Tickets</button>
</div>

<!-- Subasta -->
<div class="card" id="auctionCard">
<h2>Subasta</h2>
<div>Prize Pool: <span id="auctionPrize">0</span> BNB</div>
<div>Puja actual: <span id="auctionBid">0</span> BNB</div>
<div>Tiempo restante: <span id="auctionTimer">00:00:00</span></div>
<div class="participants" id="auctionParticipants"></div>
<button onclick="makeBid()">Pujar</button>
</div>

<!-- Gráficas -->
<div class="card">
<h2>Ranking BNB Ganado</h2>
<canvas id="bnbChart"></canvas>
</div>
</div>

<script>
let web3;
let account;
const contractAddress = '0x1A7555635e049631744AD31Ca7b55CD439F3D7B9';
const contractABI = [{"inputs":[{"internalType":"address","name":"_treasury","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[],"name":"AUCTION_INCREMENT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"AUCTION_START","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"FEE_OWNER","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"FEE_TREASURY","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"STAKE_UNIT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"TICKET_1","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"TICKET_10","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"TICKET_5","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"auction","outputs":[{"internalType":"uint256","name":"prize","type":"uint256"},{"internalType":"uint256","name":"currentBid","type":"uint256"},{"internalType":"uint256","name":"endTime","type":"uint256"},{"internalType":"bool","name":"active","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"auctionHistory","outputs":[{"internalType":"uint256","name":"prize","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"bid","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"bnbGanadoRifas","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"bnbGanadoSubastas","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint8","name":"pack","type":"uint8"}],"name":"buyTickets","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"closeAuction","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bool","name":"daily","type":"bool"}],"name":"closeRaffle","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"knownUser","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"lastStakeClaim","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"pendingWithdraw","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"raffleDaily","outputs":[{"internalType":"bool","name":"isDaily","type":"bool"},{"internalType":"uint256","name":"prize","type":"uint256"},{"internalType":"uint256","name":"endTime","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"raffleHistory","outputs":[{"internalType":"uint256","name":"prize","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"raffleHourly","outputs":[{"internalType":"bool","name":"isDaily","type":"bool"},{"internalType":"uint256","name":"prize","type":"uint256"},{"internalType":"uint256","name":"endTime","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"stake","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"stakedBNB","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"stakingFeesPaid","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"ticketsComprados","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"ticketsGastados","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"ticketsStaking","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalBNBRecaudado","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalBNBRepartidoRifas","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalBNBRepartidoSubastas","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalBNBStaked","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalTicketsVendidos","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalUsuarios","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"treasury","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"bool","name":"daily","type":"bool"}],"name":"useTickets","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"}]; // ABI aquí
let raffleHourly, raffleDaily, auction;

async function connectWallet() {
    if (window.ethereum) {
        try {
            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            account = accounts[0];
            document.getElementById('walletAddress').innerText = 'Conectado: ' + account;
            web3 = new Web3(window.ethereum);
            contract = new web3.eth.Contract(contractABI, contractAddress);
            loadStats();
            loadEvents();
            startTimers();
        } catch (err) {
            alert('Error conectando la wallet');
        }
    } else {
        alert('Instala MetaMask');
    }
}
document.getElementById('connectWalletBtn').onclick = connectWallet;

async function loadStats() {
    document.getElementById('totalBNB').innerText = web3.utils.fromWei(await contract.methods.totalBNBRecaudado().call(), 'ether');
    document.getElementById('totalTickets').innerText = await contract.methods.totalTicketsVendidos().call();
    const tickets = await contract.methods.ticketsComprados(account).call();
    const staking = await contract.methods.ticketsStaking(account).call();
    document.getElementById('myTickets').innerText = parseInt(tickets) + parseInt(staking);
}

async function loadEvents() {
    raffleHourly = await contract.methods.raffleHourly().call();
    raffleDaily = await contract.methods.raffleDaily().call();
    auction = await contract.methods.auction().call();

    document.getElementById('hourlyPrize').innerText = web3.utils.fromWei(raffleHourly.prize, 'ether');
    document.getElementById('dailyPrize').innerText = web3.utils.fromWei(raffleDaily.prize, 'ether');
    document.getElementById('auctionPrize').innerText = web3.utils.fromWei(auction.prize, 'ether');
    document.getElementById('auctionBid').innerText = web3.utils.fromWei(auction.currentBid, 'ether');

    updateParticipants();
}

function startTimers() {
    setInterval(updateTimers, 1000);
}

function updateTimers() {
    updateTimer('hourlyTimer', raffleHourly.endTime);
    updateTimer('dailyTimer', raffleDaily.endTime);
    updateTimer('auctionTimer', auction.endTime);
}

function updateTimer(elementId, endTime) {
    const now = Math.floor(Date.now() / 1000);
    let diff = endTime - now;
    if(diff < 0) diff = 0;
    const hrs = Math.floor(diff/3600).toString().padStart(2,'0');
    const min = Math.floor((diff%3600)/60).toString().padStart(2,'0');
    const sec = (diff%60).toString().padStart(2,'0');
    document.getElementById(elementId).innerText = `${hrs}:${min}:${sec}`;
}

async function updateParticipants() {
    const hourlyPart = raffleHourly.participants;
    const dailyPart = raffleDaily.participants;
    const auctionPart = auction.lastBidders;

    document.getElementById('hourlyParticipants').innerHTML = hourlyPart.map(a=>`<div>${a}</div>`).join('');
    document.getElementById('dailyParticipants').innerHTML = dailyPart.map(a=>`<div>${a}</div>`).join('');
    document.getElementById('auctionParticipants').innerHTML = auctionPart.map(a=>`<div>${a}</div>`).join('');
}

async function useTicketsRaffle(daily) {
    const amount = prompt('¿Cuántos tickets quieres usar?');
    if(!amount) return;
    try {
        await contract.methods.useTickets(amount, daily).send({ from: account });
        loadStats();
        loadEvents();
    } catch(e) { console.error(e); alert('Error usando tickets'); }
}

async function makeBid() {
    try {
        const minBid = web3.utils.toWei((parseFloat(web3.utils.fromWei(auction.currentBid, 'ether')) + 0.001).toString(), 'ether');
        await contract.methods.bid().send({ from: account, value: minBid });
        loadStats();
        loadEvents();
    } catch(e) { console.error(e); alert('Error en la puja'); }
}
</s
