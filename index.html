<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Hybrid Raffle & Auction</title>

<script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>

<style>
body {
  margin: 0;
  font-family: Inter, Arial, sans-serif;
  background: radial-gradient(circle at top, #111827, #020617);
  color: #e5e7eb;
}

header {
  padding: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: rgba(0,0,0,.4);
  backdrop-filter: blur(12px);
}

button {
  background: linear-gradient(135deg, #22d3ee, #3b82f6);
  border: none;
  padding: 10px 16px;
  border-radius: 10px;
  font-weight: bold;
  cursor: pointer;
  color: #020617;
}

.grid {
  padding: 20px;
  display: grid;
  gap: 20px;
  grid-template-columns: repeat(auto-fit, minmax(320px,1fr));
}

.card {
  background: rgba(15,23,42,.9);
  border-radius: 18px;
  padding: 18px;
  box-shadow: 0 0 40px rgba(34,211,238,.08);
}

h2 {
  margin-top: 0;
  color: #22d3ee;
}

.stat {
  display: flex;
  justify-content: space-between;
  margin: 6px 0;
}

.timer {
  font-size: 20px;
  font-weight: bold;
  color: #facc15;
}

.list {
  margin-top: 10px;
  max-height: 150px;
  overflow-y: auto;
  font-size: 14px;
}

.list div {
  padding: 4px 0;
  border-bottom: 1px solid rgba(255,255,255,.05);
}
</style>
</head>

<body>

<header>
  <h1>üéü Hybrid Raffle & Auction</h1>
  <button id="connectBtn">Conectar MetaMask</button>
</header>

<div class="grid">

<!-- USER -->
<div class="card">
  <h2>üë§ Tu cuenta</h2>
  <div class="stat"><span>Wallet</span><span id="addr">-</span></div>
  <div class="stat"><span>Tickets disponibles</span><span id="tickets">0</span></div>
  <div class="stat"><span>BNB pendiente</span><span id="pending">0</span></div>
  <button onclick="withdraw()">Retirar BNB</button>
</div>

<!-- RIFA HORARIA -->
<div class="card">
  <h2>‚è± Rifa horaria</h2>
  <div class="timer" id="timerHourly">--</div>
  <div class="stat"><span>Prize</span><span id="prizeHourly">0</span></div>
  <button onclick="useTickets(1,false)">Usar 1 ticket</button>
  <button onclick="useTickets(5,false)">Usar 5 tickets</button>
  <div class="list" id="playersHourly"></div>
</div>

<!-- RIFA DIARIA -->
<div class="card">
  <h2>üìÖ Rifa diaria</h2>
  <div class="timer" id="timerDaily">--</div>
  <div class="stat"><span>Prize</span><span id="prizeDaily">0</span></div>
  <button onclick="useTickets(1,true)">Usar 1 ticket</button>
  <button onclick="useTickets(5,true)">Usar 5 tickets</button>
  <div class="list" id="playersDaily"></div>
</div>

<!-- SUBASTA -->
<div class="card">
  <h2>üî® Subasta</h2>
  <div class="timer" id="timerAuction">--</div>
  <div class="stat"><span>Puja actual</span><span id="bid">0</span></div>
  <div class="stat"><span>Prize</span><span id="auctionPrize">0</span></div>
  <button onclick="bid()">Pujar +0.001 BNB</button>
  <div class="list" id="bidders"></div>
</div>

</div>

<script>
let web3, contract, user;

const CONTRACT_ADDRESS = "0xd06c769c6999dc2Ec8182D3430e72aC5DE3F5dE4";
const ABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[],"name":"AUCTION_INCREMENT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"AUCTION_START","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"FEE_OWNER","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"FEE_TREASURY","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"STAKE_UNIT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"TICKET_1","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"TICKET_10","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"TICKET_5","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"auction","outputs":[{"internalType":"uint256","name":"prize","type":"uint256"},{"internalType":"uint256","name":"currentBid","type":"uint256"},{"internalType":"uint256","name":"endTime","type":"uint256"},{"internalType":"bool","name":"active","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"auctionHistory","outputs":[{"internalType":"uint256","name":"prize","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"bid","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"bnbGanadoRifas","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"bnbGanadoSubastas","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint8","name":"amount","type":"uint8"}],"name":"buyTickets","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"closeAuction","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bool","name":"daily","type":"bool"}],"name":"closeRaffle","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"knownUser","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"lastStakeClaim","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"pendingWithdraw","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"raffleDaily","outputs":[{"internalType":"bool","name":"isDaily","type":"bool"},{"internalType":"uint256","name":"prize","type":"uint256"},{"internalType":"uint256","name":"endTime","type":"uint256"},{"internalType":"bool","name":"closed","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"raffleHistory","outputs":[{"internalType":"uint256","name":"prize","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"raffleHourly","outputs":[{"internalType":"bool","name":"isDaily","type":"bool"},{"internalType":"uint256","name":"prize","type":"uint256"},{"internalType":"uint256","name":"endTime","type":"uint256"},{"internalType":"bool","name":"closed","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"stake","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"stakedBNB","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"ticketsComprados","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"ticketsGastados","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"ticketsStaking","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalBNBRecaudado","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalBNBRepartidoRifas","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalBNBRepartidoSubastas","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalTicketsVendidos","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalUsuarios","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"bool","name":"daily","type":"bool"}],"name":"useTickets","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"}];

document.getElementById("connectBtn").onclick = async () => {
  web3 = new Web3(window.ethereum);
  const accs = await ethereum.request({ method: "eth_requestAccounts" });
  user = accs[0];
  document.getElementById("addr").innerText =
    user.slice(0,6)+"..."+user.slice(-4);
  contract = new web3.eth.Contract(ABI, CONTRACT_ADDRESS);
  loadAll();
};

async function loadAll() {
  loadUser();
  loadRaffles();
  loadAuction();
}

async function loadUser() {
  const bought = await contract.methods.ticketsComprados(user).call();
  const staking = await contract.methods.ticketsStaking(user).call();
  const pending = await contract.methods.pendingWithdraw(user).call();

  document.getElementById("tickets").innerText =
    Number(bought) + Number(staking);
  document.getElementById("pending").innerText =
    web3.utils.fromWei(pending);
}

async function loadRaffles() {
  const h = await contract.methods.raffleHourly().call();
  const d = await contract.methods.raffleDaily().call();

  document.getElementById("prizeHourly").innerText =
    web3.utils.fromWei(h.prize);
  document.getElementById("prizeDaily").innerText =
    web3.utils.fromWei(d.prize);

  startTimer(h.endTime, "timerHourly", () =>
    contract.methods.closeRaffle(false).send({from:user})
  );
  startTimer(d.endTime, "timerDaily", () =>
    contract.methods.closeRaffle(true).send({from:user})
  );

  renderList("playersHourly", h.participants);
  renderList("playersDaily", d.participants);
}

async function loadAuction() {
  const a = await contract.methods.auction().call();

  document.getElementById("bid").innerText =
    web3.utils.fromWei(a.currentBid);
  document.getElementById("auctionPrize").innerText =
    web3.utils.fromWei(a.prize);

  startTimer(a.endTime, "timerAuction", () =>
    contract.methods.closeAuction().send({from:user})
  );

  renderList("bidders", a.lastBidders);
}

function startTimer(end, el, onEnd) {
  setInterval(async () => {
    const now = Math.floor(Date.now()/1000);
    let diff = end - now;
    if (diff <= 0) {
      document.getElementById(el).innerText = "FINALIZADO";
      await onEnd();
      return;
    }
    const h = Math.floor(diff/3600);
    const m = Math.floor((diff%3600)/60);
    const s = diff%60;
    document.getElementById(el).innerText = `${h}h ${m}m ${s}s`;
  },1000);
}

function renderList(id, arr) {
  const el = document.getElementById(id);
  el.innerHTML = "";
  arr.slice().reverse().forEach(a=>{
    const d = document.createElement("div");
    d.innerText = a.slice(0,6)+"..."+a.slice(-4);
    el.appendChild(d);
  });
}

async function useTickets(n, daily) {
  await contract.methods.useTickets(n, daily).send({from:user});
  loadAll();
}

async function bid() {
  await contract.methods.bid().send({
    from: user,
    value: web3.utils.toWei("0.001")
  });
  loadAll();
}

async function withdraw() {
  await contract.methods.withdraw().send({from:user});
  loadUser();
}
</script>

</body>
</html>
