<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hybrid Raffle & Auction BSC</title>
<script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    body { font-family: Arial, sans-serif; background: #0f111a; color: #fff; margin:0; padding:0;}
    header { background: linear-gradient(90deg,#6a11cb,#2575fc); padding: 1rem; text-align:center; font-size:1.5rem; font-weight:bold; }
    .container { padding: 2rem; max-width: 1400px; margin:auto;}
    button { padding: 0.5rem 1rem; margin:0.3rem; cursor:pointer; background:#2575fc; color:#fff; border:none; border-radius:6px; transition:0.2s;}
    button:hover { background:#6a11cb;}
    .card { background:#1b1f36; padding:1rem; border-radius:10px; margin-bottom:1rem; box-shadow:0 0 10px rgba(0,0,0,0.5);}
    h2 { margin-top:0;}
    .flex { display:flex; flex-wrap:wrap; gap:1rem; }
    .stats { background:#22263a; padding:1rem; border-radius:10px; margin-bottom:1rem;}
    .green { color:#4caf50; font-weight:bold;}
    .red { color:#f44336; font-weight:bold;}
    canvas { background:#1b1f36; border-radius:10px; margin-top:1rem;}
</style>
</head>
<body>

<header>Hybrid Raffle & Auction BSC</header>

<div class="container">
    <div class="card">
        <button id="connectWalletBtn">Conectar Wallet</button>
        <span id="walletAddress"></span>
        <div>BNB Balance: <span id="bnbBalance">0</span></div>
        <div>Tickets Disponibles: <span id="ticketsAvailable">0</span></div>
        <div>Tickets por Staking: <span id="stakingTickets">0</span></div>
        <div>Ganancias Pendientes Rifa: <span id="pendingRaffle">0</span> BNB</div>
        <div>Ganancias Pendientes Subasta: <span id="pendingAuction">0</span> BNB</div>
        <button id="withdrawBtn">Retirar Ganancias</button>
    </div>

    <div class="card">
        <h2>Rifas</h2>
        <div id="raffleContainer"></div>
        <canvas id="raffleChart" height="150"></canvas>
    </div>

    <div class="card">
        <h2>Subasta Actual</h2>
        <div id="auctionContainer"></div>
        <canvas id="auctionChart" height="150"></canvas>
        <button id="bidBtn">Pujar 0.001 BNB</button>
    </div>

    <div class="card">
        <h2>Staking</h2>
        <input type="number" step="0.001" id="stakeAmount" placeholder="Cantidad en BNB"/>
        <button id="stakeBtn">Stake</button>
        <input type="number" step="0.001" id="withdrawStakeAmount" placeholder="Cantidad a retirar"/>
        <button id="withdrawStakeBtn">Retirar Stake</button>
    </div>
</div>

<script>
let web3;
let contract;
let walletAddress;
const CONTRACT_ADDRESS = "TU_DIRECCION_DEL_CONTRATO";
const ABI = [/* Pega aquí el ABI del contrato HybridRaffleAuctionBSCAutoFinal */];

async function connectWallet() {
    if(window.ethereum){
        web3 = new Web3(window.ethereum);
        try {
            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            walletAddress = accounts[0];
            document.getElementById("walletAddress").innerText = walletAddress;
            contract = new web3.eth.Contract(ABI, CONTRACT_ADDRESS);
            updateStats();
            startIntervals();
        } catch(e){
            console.error(e);
            alert("Error conectando la wallet");
        }
    } else {
        alert("Instala Metamask");
    }
}
document.getElementById("connectWalletBtn").onclick = connectWallet;

// ---------------- Stats ----------------
async function updateStats(){
    if(!contract || !walletAddress) return;
    try {
        const bnbBalance = await web3.eth.getBalance(walletAddress);
        document.getElementById("bnbBalance").innerText = web3.utils.fromWei(bnbBalance, 'ether');

        const tickets = await contract.methods.ticketsAvailable(walletAddress).call();
        document.getElementById("ticketsAvailable").innerText = tickets;

        const stakingTickets = await contract.methods.stakingTickets(walletAddress).call();
        document.getElementById("stakingTickets").innerText = stakingTickets;

        const pendingR = await contract.methods.pendingRaffle(walletAddress).call();
        document.getElementById("pendingRaffle").innerText = web3.utils.fromWei(pendingR, 'ether');

        const pendingA = await contract.methods.pendingAuction(walletAddress).call();
        document.getElementById("pendingAuction").innerText = web3.utils.fromWei(pendingA, 'ether');

        renderRaffles();
        renderAuction();
    } catch(e){ console.error(e); }
}

// ---------------- RIFAS ----------------
async function renderRaffles(){
    const container = document.getElementById("raffleContainer");
    container.innerHTML = "";
    const count = await contract.methods.rafflesCount().call();
    const labels = [], prizes = [];
    for(let i=0;i<count;i++){
        const r = await contract.methods.getRaffle(i).call();
        const [prizeGuaranteed, prizeCurrent, endTime, winnersCount, isDaily, participants, winners, closed] = r;
        const type = isDaily ? "Diaria" : "Horaria";
        const timeLeft = Math.max(0, endTime - Math.floor(Date.now()/1000));
        const div = document.createElement("div");
        div.className = "stats";
        div.innerHTML = `
            <strong>Rifa ${type}</strong><br>
            Prize Pool: ${web3.utils.fromWei(prizeCurrent,'ether')} BNB<br>
            Participantes: ${participants.length}<br>
            Ganadores: ${winners.map(w => w.slice(0,6)+'...').join(', ') || '-'}<br>
            Tiempo restante: <span id="raffleTimer${i}">${formatTime(timeLeft)}</span><br>
            <button onclick="useTicket(${isDaily},1)">Usar 1 Ticket</button>
            <button onclick="useTicket(${isDaily},5)">Usar 5 Tickets</button>
            <button onclick="useTicket(${isDaily},10)">Usar 10 Tickets</button>
        `;
        container.appendChild(div);
        labels.push(`Rifa ${type}`);
        prizes.push(web3.utils.fromWei(prizeCurrent,'ether'));
    }
    renderChart("raffleChart",labels,prizes,"BNB Prize Pool");
}

// ---------------- USAR TICKETS ----------------
async function useTicket(isDaily,num){
    try{
        const tx = await contract.methods.useTicketsInRaffle(num,isDaily).send({from: walletAddress});
        console.log(tx);
        updateStats();
    } catch(e){ console.error(e); alert("Error usando tickets"); }
}

// ---------------- SUBASTA ----------------
async function renderAuction(){
    const container = document.getElementById("auctionContainer");
    const count = await contract.methods.auctionsCount().call();
    if(count==0) { container.innerHTML = "No hay subasta activa"; return; }
    const a = await contract.methods.getAuction(count-1).call();
    const [prizeGuaranteed, prizeCurrent, currentBid, endTime, lastBidders, active] = a;
    const timeLeft = Math.max(0,endTime - Math.floor(Date.now()/1000));
    container.innerHTML = `
        Premio Garantizado: ${web3.utils.fromWei(prizeGuaranteed,'ether')} BNB<br>
        Premio Actual: ${web3.utils.fromWei(prizeCurrent,'ether')} BNB<br>
        Puja Actual: ${web3.utils.fromWei(currentBid,'ether')} BNB<br>
        Últimos pujadores: ${lastBidders.map(b => b.slice(0,6)+'...').join(', ')}<br>
        Tiempo restante: <span id="auctionTimer">${formatTime(timeLeft)}</span>
    `;
    renderChart("auctionChart",lastBidders.map(b=>b.slice(0,6)),lastBidders.map(()=>parseFloat(web3.utils.fromWei(currentBid,'ether'))),"Puja Actual BNB");
}

// ---------------- PUJAR ----------------
document.getElementById("bidBtn").onclick = async () => {
    try{
        const tx = await contract.methods.bid().send({from: walletAddress,value:web3.utils.toWei("0.001","ether")});
        console.log(tx);
        updateStats();
    } catch(e){ console.error(e); alert("Error en la puja"); }
};

// ---------------- STAKING ----------------
document.getElementById("stakeBtn").onclick = async () => {
    const amount = document.getElementById("stakeAmount").value;
    if(amount<=0){ alert("Ingresa cantidad >0"); return; }
    try{
        const tx = await contract.methods.stakeTokens().send({from: walletAddress,value:web3.utils.toWei(amount,'ether')});
        console.log(tx);
        updateStats();
    } catch(e){ console.error(e); alert("Error staking"); }
};

document.getElementById("withdrawStakeBtn").onclick = async () => {
    const amount = document.getElementById("withdrawStakeAmount").value;
    if(amount<=0){ alert("Cantidad invalida"); return; }
    try{
        const tx = await contract.methods.withdrawStake(web3.utils.toWei(amount,'ether')).send({from: walletAddress});
        console.log(tx);
        updateStats();
    } catch(e){ console.error(e); alert("Error retirando stake"); }
};

// ---------------- RETIRAR GANANCIAS ----------------
document.getElementById("withdrawBtn").onclick = async () => {
    try{
        const tx = await contract.methods.withdraw().send({from: walletAddress});
        console.log(tx);
        updateStats();
    } catch(e){ console.error(e); alert("Error retirando ganancias"); }
};

// ---------------- TIMER ----------------
function formatTime(seconds){
    const h = Math.floor(seconds/3600);
    const m = Math.floor((seconds%3600)/60);
    const s = seconds%60;
    return `${h}h ${m}m ${s}s`;
}

function startIntervals(){
    setInterval(updateTimers,1000);
}

async function updateTimers(){
    const raffleCount = await contract.methods.rafflesCount().call();
    for(let i=0;i<raffleCount;i++){
        const r = await contract.methods.getRaffle(i).call();
        const endTime = r[2];
        const timeLeft = Math.max(0,endTime - Math.floor(Date.now()/1000));
        const el = document.getElementById("raffleTimer"+i);
        if(el) el.innerText = formatTime(timeLeft);
    }
    const auctionCount = await contract.methods.auctionsCount().call();
    if(auctionCount>0){
        const a = await contract.methods.getAuction(auctionCount-1).call();
        const endTime = a[3];
        const timeLeft = Math.max(0,endTime - Math.floor(Date.now()/1000));
        const el = document.getElementById("auctionTimer");
        if(el) el.innerText = formatTime(timeLeft);
    }
}

function renderChart(id,labels,data,label){
    const ctx = document.getElementById(id).getContext('2d');
    if(window[id+'_chart']) window[id+'_chart'].destroy();
    window[id+'_chart'] = new Chart(ctx,{
        type:'bar',
        data:{labels, datasets:[{label,data,backgroundColor:'#2575fc'}]},
        options:{scales:{y:{beginAtZero:true}}}
    });
}

</script>
</body>
</html>
