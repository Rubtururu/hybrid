<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Hybrid Raffle & Auction Ultra Premium</title>
<script src="https://cdn.jsdelivr.net/npm/web3@1.9.0/dist/web3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* --- Estilos globales --- */
body { font-family:'Inter',sans-serif; background:#0a0a15; color:#fff; margin:0; padding:0;}
header { background:#1b1b2f; padding:1rem; text-align:center; font-size:2rem; font-weight:bold; box-shadow:0 2px 12px rgba(0,0,0,0.8);}
.container { max-width:1400px; margin:2rem auto; display:grid; grid-template-columns:repeat(auto-fit,minmax(350px,1fr)); gap:2rem; }
.card { background:#1e1e2f; border-radius:1rem; padding:1.5rem; box-shadow:0 6px 25px rgba(0,0,0,0.6); position:relative; transition: transform 0.3s, box-shadow 0.3s; overflow:hidden;}
.card:hover { transform:translateY(-7px); box-shadow:0 8px 30px rgba(0,0,0,0.8); }
button { background:linear-gradient(135deg,#4b7bec,#3867d6); color:white; border:none; padding:0.7rem 1.2rem; border-radius:0.5rem; cursor:pointer; transition:0.2s; margin-top:0.5rem; font-weight:bold; }
button:hover { background:linear-gradient(135deg,#3867d6,#4b7bec);}
input[type="number"] { padding:0.5rem; border-radius:0.4rem; border:1px solid #555; width:80px; margin-right:0.5rem; background:#2a2a3d; color:white; }
h2 { margin-top:0; font-size:1.4rem; color:#fff; text-align:center; text-shadow:0 0 5px #4b7bec; }
.stats { display:flex; flex-direction:column; gap:0.5rem; margin-top:1rem; font-size:0.9rem;}
.stats span { font-weight:bold; color:#aaa; }
.countdown { font-weight:bold; font-size:1.2rem; color:#ffd700; margin-top:0.5rem; }
ul { list-style:none; padding-left:0; max-height:120px; overflow-y:auto; }
li { padding:0.2rem 0; }
li.top1 { color:#ffd700; font-weight:bold; text-shadow:0 0 5px #ffd700; }
li.top2 { color:#c0c0c0; font-weight:bold; text-shadow:0 0 5px #c0c0c0; }
li.top3 { color:#cd7f32; font-weight:bold; text-shadow:0 0 5px #cd7f32; }
.confetti { position:absolute; width:100%; height:100%; pointer-events:none; top:0; left:0; }
.progress-bar { background:#2a2a3d; border-radius:0.5rem; height:20px; width:100%; margin-top:0.5rem; overflow:hidden; }
.progress-fill { background:linear-gradient(90deg,#ffd700,#ff7f50); height:100%; width:0%; transition:width 0.5s; border-radius:0.5rem;}
.history-table { width:100%; border-collapse: collapse; margin-top:1rem; font-size:0.85rem; }
.history-table th, .history-table td { border:1px solid #333; padding:0.4rem 0.8rem; text-align:center; }
.history-table th { background:#333; }
.notification { position:fixed; top:10px; right:10px; background:linear-gradient(135deg,#4b7bec,#3867d6); padding:0.7rem 1.2rem; border-radius:0.5rem; font-weight:bold; box-shadow:0 2px 10px rgba(0,0,0,0.6); opacity:0; transform:translateY(-20px); transition:0.5s; color:white; }
</style>
</head>
<body>
<header>Hybrid Raffle & Auction Ultra Premium</header>

<div class="container">
    <!-- Rifas -->
    <div class="card">
        <h2>Rifas</h2>
        <p>Comprar tickets:</p>
        <input type="number" id="ticketsAmount" value="1" min="1">
        <button onclick="buyTickets()">Comprar</button>
        <div class="stats">
            <span>Balance contrato: <span id="contractBalance">0</span> BNB</span>
            <span>Reserva mínima: <span id="reserveMin">0</span> BNB</span>
            <span>Prize pool activo: <span id="activePrizePool">0</span> BNB</span>
            <span>Rifa countdown: <span class="countdown" id="raffleCountdown">00:00:00</span></span>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="raffleProgress"></div></div>
        <p>Últimos ganadores:</p>
        <ul id="raffleWinners"></ul>
    </div>

    <!-- Subastas -->
    <div class="card">
        <h2>Subastas</h2>
        <p>Pujar:</p>
        <input type="number" id="bidAmount" value="1" min="0.1" step="0.1">
        <button onclick="placeBid()">Pujar</button>
        <div class="stats">
            <span>Prize pool subasta: <span id="auctionPrizePool">0</span> BNB</span>
            <span>Current bid: <span id="currentBid">0</span> BNB</span>
            <span>Subasta countdown: <span class="countdown" id="auctionCountdown">00:00:00</span></span>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="auctionProgress"></div></div>
        <p>Top 10 últimos bidders:</p>
        <ul id="topBidders"></ul>
    </div>

    <!-- Staking -->
    <div class="card">
        <h2>Staking</h2>
        <p>Stakear BNB:</p>
        <input type="number" id="stakeAmount" value="1" min="0.1" step="0.1">
        <button onclick="stakeTokens()">Stakear</button>
        <p>Retirar stake:</p>
        <input type="number" id="withdrawAmount" value="1" min="0.1" step="0.1">
        <button onclick="withdrawStake()">Retirar</button>
        <div class="stats">
            <span>Mi stake: <span id="myStake">0</span> BNB</span>
            <span>Mis tickets: <span id="myTickets">0</span></span>
        </div>
    </div>

    <!-- Crear eventos -->
    <div class="card">
        <h2>Crear Eventos</h2>
        <button onclick="createRaffle(true)">Crear rifa diaria</button>
        <button onclick="createRaffle(false)">Crear rifa horaria</button>
        <button onclick="createAuction()">Crear subasta</button>
    </div>
</div>

<div id="confettiContainer" class="confetti"></div>
<div id="notification" class="notification"></div>

<script>
// ----------------- Variables y conexión -----------------
let web3, contract;
const contractAddress = "0x5f63d2C0656AC296c77E9d373114008d338e1f6e";
const contractABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[],"name":"Rmin","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"auctions","outputs":[{"internalType":"uint128","name":"prizeGarantizado","type":"uint128"},{"internalType":"uint128","name":"prizeActual","type":"uint128"},{"internalType":"uint128","name":"currentBid","type":"uint128"},{"internalType":"uint64","name":"endTime","type":"uint64"},{"internalType":"bool","name":"active","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"balance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"numTickets","type":"uint256"}],"name":"buyTickets","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"index","type":"uint256"}],"name":"cerrarRifa","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"index","type":"uint256"}],"name":"cerrarSubasta","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"creador","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bool","name":"diaria","type":"bool"},{"internalType":"uint256","name":"ticketsEsperados","type":"uint256"}],"name":"crearRifa","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"prizeMin","type":"uint256"}],"name":"crearSubasta","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"feeCreador","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"feeTesoro","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"index","type":"uint256"}],"name":"pujar","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"raffles","outputs":[{"internalType":"uint128","name":"prizeGarantizado","type":"uint128"},{"internalType":"uint128","name":"prizeActual","type":"uint128"},{"internalType":"uint64","name":"endTime","type":"uint64"},{"internalType":"uint8","name":"winnersCount","type":"uint8"},{"internalType":"bool","name":"isDaily","type":"bool"},{"internalType":"bool","name":"closed","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"retirarStake","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"stakeTokens","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"staked","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"tickets","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}];

async function init() {
    if(window.ethereum){
        web3 = new Web3(window.ethereum);
        await ethereum.request({ method: "eth_requestAccounts" });
        contract = new web3.eth.Contract(contractABI, contractAddress);
        updateStats();
        setInterval(updateStats, 5000);
    } else { alert("Instala MetaMask para usar la DApp"); }
}

// ----------------- Funciones -----------------
async function buyTickets(){
    try{
        const numTickets = parseInt(document.getElementById("ticketsAmount").value);
        const accounts = await web3.eth.getAccounts();
        const price = await contract.methods.calcularPrecioTickets(numTickets).call();
        await contract.methods.buyTickets(numTickets).send({from: accounts[0], value: price});
        updateStats();
        showNotification("Tickets comprados!");
    } catch(e){ console.error(e); alert("Error en la compra de tickets"); }
}

async function createRaffle(daily){
    try{
        const accounts = await web3.eth.getAccounts();
        await contract.methods.crearRifa(daily, 100).send({from: accounts[0]});
        updateStats();
        showNotification(daily?"Rifa diaria creada":"Rifa horaria creada");
    } catch(e){ console.error(e); alert("Error creando rifa"); }
}

async function createAuction(){
    try{
        const accounts = await web3.eth.getAccounts();
        const prizeMin = web3.utils.toWei("1","ether");
        await contract.methods.crearSubasta(prizeMin).send({from: accounts[0]});
        updateStats();
        showNotification("Subasta creada");
    } catch(e){ console.error(e); alert("Error creando subasta"); }
}

async function placeBid(){
    try{
        const bidEth = document.getElementById("bidAmount").value;
        const bidWei = web3.utils.toWei(bidEth,"ether");
        const accounts = await web3.eth.getAccounts();
        const auctionCount = await contract.methods.auctionsCount().call();
        await contract.methods.pujar(auctionCount-1).send({from: accounts[0], value: bidWei});
        updateStats();
        showNotification("Puja realizada!");
    } catch(e){ console.error(e); alert("Error en la puja"); }
}

async function stakeTokens(){
    try{
        const stakeEth = document.getElementById("stakeAmount").value;
        const stakeWei = web3.utils.toWei(stakeEth,"ether");
        const accounts = await web3.eth.getAccounts();
        await contract.methods.stakeTokens().send({from: accounts[0], value: stakeWei});
        updateStats();
        showNotification("Stake realizado!");
    } catch(e){ console.error(e); alert("Error stakeando"); }
}

async function withdrawStake(){
    try{
        const withdrawEth = document.getElementById("withdrawAmount").value;
        const withdrawWei = web3.utils.toWei(withdrawEth,"ether");
        const accounts = await web3.eth.getAccounts();
        await contract.methods.retirarStake(withdrawWei).send({from: accounts[0]});
        updateStats();
        showNotification("Stake retirado!");
    } catch(e){ console.error(e); alert("Error retirando stake"); }
}

// ----------------- Actualización stats -----------------
async function updateStats(){
    try{
        const accounts = await web3.eth.getAccounts();
        const balance = await web3.eth.getBalance(contractAddress);
        document.getElementById("contractBalance").innerText = web3.utils.fromWei(balance,"ether");

        const rmin = await contract.methods.Rmin().call();
        document.getElementById("reserveMin").innerText = web3.utils.fromWei(rmin,"ether");

        const raffleCount = await contract.methods.raffles.length ? await contract.methods.raffles.length.call() : 0;
        if(raffleCount>0){
            const r = await contract.methods.raffles(raffleCount-1).call();
            document.getElementById("activePrizePool").innerText = web3.utils.fromWei(r.prizeActual,"ether");
            const winners = r.winners;
            const winnersList = document.getElementById("raffleWinners");
            winnersList.innerHTML="";
            winners.forEach((w,i)=>{
                const li = document.createElement("li"); li.innerText=w;
                if(i===0) li.classList.add("top1"); else if(i===1) li.classList.add("top2"); else if(i===2) li.classList.add("top3");
                winnersList.appendChild(li);
            });
        }

        const auctionCount = await contract.methods.auctions.length ? await contract.methods.auctions.length.call() : 0;
        if(auctionCount>0){
            const a = await contract.methods.auctions(auctionCount-1).call();
            document.getElementById("auctionPrizePool").innerText = web3.utils.fromWei(a.prizeActual,"ether");
            document.getElementById("currentBid").innerText = web3.utils.fromWei(a.currentBid,"ether");
            const bidders = a.lastBidders;
            const biddersList = document.getElementById("topBidders");
            biddersList.innerHTML="";
            bidders.forEach((b,i)=>{
                const li=document.createElement("li"); li.innerText=b;
                if(i===0) li.classList.add("top1"); else if(i===1) li.classList.add("top2"); else if(i===2) li.classList.add("top3");
                biddersList.appendChild(li);
            });
        }

        const myStake = await contract.methods.staked(accounts[0]).call();
        document.getElementById("myStake").innerText = web3.utils.fromWei(myStake,"ether");
        const myTickets = await contract.methods.tickets(accounts[0]).call();
        document.getElementById("myTickets").innerText = myTickets;

    } catch(e){ console.error(e); }
}

// ----------------- Confetti -----------------
function launchConfetti(){ /* Puedes añadir animación de confetti aquí */ }

// ----------------- Notificaciones -----------------
function showNotification(msg){
    const el = document.getElementById("notification");
    el.innerText = msg;
    el.style.opacity = 1; el.style.transform="translateY(0)";
    setTimeout(()=>{ el.style.opacity=0; el.style.transform="translateY(-20px)"; },3000);
}

window.onload = init;
</script>
</body>
</html>
