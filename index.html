<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hybrid Raffle & Auction Premium</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
  /* ======= Reset bÃ¡sico ======= */
  * { margin:0; padding:0; box-sizing:border-box; font-family: 'Arial', sans-serif; }
  body { background: linear-gradient(120deg,#ff9a9e,#fad0c4); color:#fff; }

  /* ======= Contenedor principal ======= */
  .container { max-width:1200px; margin:0 auto; padding:20px; }

  /* ======= Header ======= */
  header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
  header h1 { font-size:2rem; color:#fff; text-shadow:2px 2px 5px #000; }
  #walletButton { background:#ffcc00; border:none; padding:10px 20px; border-radius:10px; cursor:pointer; font-weight:bold; color:#000; transition:0.3s; }
  #walletButton:hover { background:#ffc700; transform:scale(1.05); }

  /* ======= Tarjetas ======= */
  .card { background:rgba(0,0,0,0.2); border-radius:15px; padding:20px; margin-bottom:20px; box-shadow:0 0 20px rgba(0,0,0,0.5); transition:0.3s; }
  .card:hover { transform:translateY(-5px); box-shadow:0 0 30px rgba(0,0,0,0.7); }
  .card h2 { display:flex; align-items:center; font-size:1.5rem; margin-bottom:10px; }
  .card h2 .material-icons { margin-right:10px; color:#ffeb3b; }

  /* ======= Botones ======= */
  .btn { background:#ff5722; border:none; padding:10px 15px; border-radius:8px; cursor:pointer; margin:5px; color:#fff; font-weight:bold; transition:0.3s; }
  .btn:hover { background:#ff784e; transform:scale(1.05); }

  /* ======= Listas ======= */
  ul { list-style:none; padding-left:0; }
  li { margin:5px 0; display:flex; justify-content:space-between; }

  /* ======= EstadÃ­sticas ======= */
  .stats { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:15px; margin-bottom:20px; }
  .stat { background:rgba(0,0,0,0.3); padding:15px; border-radius:10px; text-align:center; transition:0.3s; }
  .stat:hover { transform:scale(1.05); }

  /* ======= Contador ======= */
  .countdown { font-size:1.3rem; font-weight:bold; color:#ffeb3b; margin-top:10px; }

  /* ======= Animaciones de cambio ======= */
  .animate-value { transition: all 0.5s ease-in-out; }

</style>
</head>
<body>
<div class="container">
  <header>
    <h1>ðŸŽ² Hybrid Raffle & Auction</h1>
    <button id="walletButton"><span class="material-icons">account_balance_wallet</span> Conectar Wallet</button>
  </header>

  <!-- ===== EstadÃ­sticas Globales ===== -->
  <div class="stats">
    <div class="stat animate-value" id="statBNBTotal">BNB Total: 0</div>
    <div class="stat animate-value" id="statBNBRifas">BNB Rifas: 0</div>
    <div class="stat animate-value" id="statBNBSubastas">BNB Subastas: 0</div>
    <div class="stat animate-value" id="statTickets">Tickets Totales: 0</div>
    <div class="stat animate-value" id="statUsuarios">Usuarios: 0</div>
    <div class="stat animate-value" id="statStaked">BNB Staked: 0</div>
  </div>

  <!-- ===== Rifa Horaria ===== -->
  <div class="card" id="raffleHourlyCard">
    <h2><span class="material-icons">timer</span> Rifa Horaria</h2>
    <p>Premio Actual: <span id="raffleHourlyPrize">0 BNB</span></p>
    <p>Participantes:</p>
    <ul id="raffleHourlyParticipants"></ul>
    <p>Ganadores:</p>
    <ul id="raffleHourlyWinners"></ul>
    <p class="countdown" id="raffleHourlyCountdown">Cargando...</p>
    <div>
      <button class="btn" onclick="useTicketsRaffle(false,1)">Usar 1 Ticket</button>
      <button class="btn" onclick="useTicketsRaffle(false,5)">Usar 5 Tickets</button>
      <button class="btn" onclick="useTicketsRaffle(false,10)">Usar 10 Tickets</button>
    </div>
  </div>

  <!-- ===== Rifa Diaria ===== -->
  <div class="card" id="raffleDailyCard">
    <h2><span class="material-icons">today</span> Rifa Diaria</h2>
    <p>Premio Actual: <span id="raffleDailyPrize">0 BNB</span></p>
    <p>Participantes:</p>
    <ul id="raffleDailyParticipants"></ul>
    <p>Ganadores:</p>
    <ul id="raffleDailyWinners"></ul>
    <p class="countdown" id="raffleDailyCountdown">Cargando...</p>
    <div>
      <button class="btn" onclick="useTicketsRaffle(true,1)">Usar 1 Ticket</button>
      <button class="btn" onclick="useTicketsRaffle(true,5)">Usar 5 Tickets</button>
      <button class="btn" onclick="useTicketsRaffle(true,10)">Usar 10 Tickets</button>
    </div>
  </div>

  <!-- ===== Subasta ===== -->
  <div class="card" id="auctionCard">
    <h2><span class="material-icons">gavel</span> Subasta</h2>
    <p>Premio Actual: <span id="auctionPrize">0 BNB</span></p>
    <p>Puja Actual: <span id="auctionBid">0 BNB</span></p>
    <p>Ãšltimos 10 pujadores:</p>
    <ul id="auctionBidders"></ul>
    <p class="countdown" id="auctionCountdown">Cargando...</p>
    <button class="btn" onclick="placeBid()">Pujar +0.001 BNB</button>
  </div>

  <!-- ===== Staking ===== -->
  <div class="card" id="stakingCard">
    <h2><span class="material-icons">savings</span> Staking</h2>
    <p>BNB Stakeado: <span id="stakedBNB">0</span></p>
    <p>Tickets Generados: <span id="stakingTickets">0</span></p>
    <input type="number" id="stakeAmount" placeholder="Cantidad BNB" step="0.01" min="0.1">
    <button class="btn" onclick="stakeBNB()">Stake</button>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.10.0/dist/web3.min.js"></script>
<script>
  let web3;
  let contract;
  let account;
  const contractAddress = "0x1A7555635e049631744AD31Ca7b55CD439F3D7B9";
  const contractABI = [{"inputs":[{"internalType":"address","name":"_treasury","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[],"name":"AUCTION_INCREMENT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"AUCTION_START","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"FEE_OWNER","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"FEE_TREASURY","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"STAKE_UNIT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"TICKET_1","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"TICKET_10","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"TICKET_5","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"auction","outputs":[{"internalType":"uint256","name":"prize","type":"uint256"},{"internalType":"uint256","name":"currentBid","type":"uint256"},{"internalType":"uint256","name":"endTime","type":"uint256"},{"internalType":"bool","name":"active","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"auctionHistory","outputs":[{"internalType":"uint256","name":"prize","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"bid","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"bnbGanadoRifas","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"bnbGanadoSubastas","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint8","name":"pack","type":"uint8"}],"name":"buyTickets","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"closeAuction","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bool","name":"daily","type":"bool"}],"name":"closeRaffle","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"knownUser","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"lastStakeClaim","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"pendingWithdraw","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"raffleDaily","outputs":[{"internalType":"bool","name":"isDaily","type":"bool"},{"internalType":"uint256","name":"prize","type":"uint256"},{"internalType":"uint256","name":"endTime","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"raffleHistory","outputs":[{"internalType":"uint256","name":"prize","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"raffleHourly","outputs":[{"internalType":"bool","name":"isDaily","type":"bool"},{"internalType":"uint256","name":"prize","type":"uint256"},{"internalType":"uint256","name":"endTime","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"stake","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"stakedBNB","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"stakingFeesPaid","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"ticketsComprados","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"ticketsGastados","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"ticketsStaking","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalBNBRecaudado","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalBNBRepartidoRifas","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalBNBRepartidoSubastas","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalBNBStaked","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalTicketsVendidos","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalUsuarios","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"treasury","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"bool","name":"daily","type":"bool"}],"name":"useTickets","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"}];

  // ===== Conectar Wallet =====
  async function connectWallet() {
    try {
      if(window.ethereum){
        web3 = new Web3(window.ethereum);
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        account = accounts[0];
        document.getElementById('walletButton').innerHTML = account.substring(0,6)+'...'+account.slice(-4);
        contract = new web3.eth.Contract(contractABI, contractAddress);
        updateAll();
      } else {
        alert("Instala MetaMask");
      }
    } catch(e) { console.error(e); alert("Error conectando wallet"); }
  }

  document.getElementById('walletButton').onclick = connectWallet;

  // ===== Funciones para actualizar UI =====
  async function updateAll(){
    if(!contract) return;
    updateStats();
    updateRaffles();
    updateAuction();
    setInterval(() => {
      updateCountdowns();
      updateStats();
      updateRaffles();
      updateAuction();
    },1000);
  }

  async function updateStats(){
    const totalBNB = await contract.methods.totalBNBRecaudado().call();
    const totalRifas = await contract.methods.totalBNBRepartidoRifas().call();
    const totalSub = await contract.methods.totalBNBRepartidoSubastas().call();
    const totalTickets = await contract.methods.totalTicketsVendidos().call();
    const totalUsers = await contract.methods.totalUsuarios().call();
    const totalStaked = await contract.methods.totalBNBStaked().call();

    document.getElementById('statBNBTotal').innerText = 'BNB Total: '+web3.utils.fromWei(totalBNB,'ether');
    document.getElementById('statBNBRifas').innerText = 'BNB Rifas: '+web3.utils.fromWei(totalRifas,'ether');
    document.getElementById('statBNBSubastas').innerText = 'BNB Subastas: '+web3.utils.fromWei(totalSub,'ether');
    document.getElementById('statTickets').innerText = 'Tickets Totales: '+totalTickets;
    document.getElementById('statUsuarios').innerText = 'Usuarios: '+totalUsers;
    document.getElementById('statStaked').innerText = 'BNB Staked: '+web3.utils.fromWei(totalStaked,'ether');
  }

  async function updateRaffles(){
    const hourly = await contract.methods.raffleHourly().call();
    const daily = await contract.methods.raffleDaily().call();

    document.getElementById('raffleHourlyPrize').innerText = web3.utils.fromWei(hourly.prize,'ether')+' BNB';
    document.getElementById('raffleDailyPrize').innerText = web3.utils.fromWei(daily.prize,'ether')+' BNB';

    updateList('raffleHourlyParticipants', hourly.participants);
    updateList('raffleHourlyWinners', hourly.winners);
    updateList('raffleDailyParticipants', daily.participants);
    updateList('raffleDailyWinners', daily.winners);
  }

  async function updateAuction(){
    const a = await contract.methods.auction().call();
    document.getElementById('auctionPrize').innerText = web3.utils.fromWei(a.prize,'ether')+' BNB';
    document.getElementById('auctionBid').innerText = web3.utils.fromWei(a.currentBid,'ether')+' BNB';
    updateList('auctionBidders', a.lastBidders);
  }

  function updateList(elementId, array){
    const ul = document.getElementById(elementId);
    ul.innerHTML = '';
    array.forEach(addr => {
      const li = document.createElement('li');
      li.innerText = addr;
      ul.appendChild(li);
    });
  }

  function updateCountdowns(){
    const now = Math.floor(Date.now()/1000);
    contract.methods.raffleHourly().call().then(r=>document.getElementById('raffleHourlyCountdown').innerText = formatCountdown(r.endTime-now));
    contract.methods.raffleDaily().call().then(r=>document.getElementById('raffleDailyCountdown').innerText = formatCountdown(r.endTime-now));
    contract.methods.auction().call().then(a=>document.getElementById('auctionCountdown').innerText = formatCountdown(a.endTime-now));
  }

  function formatCountdown(seconds){
    if(seconds<0) return '0s';
    const h = Math.floor(seconds/3600);
    const m = Math.floor((seconds%3600)/60);
    const s = seconds%60;
    return `${h}h ${m}m ${s}s`;
  }

  // ===== Funciones de acciones =====
  async function useTicketsRaffle(daily, amount){
    if(!contract) return;
    try{
      await contract.methods.useTickets(amount, daily).send({from:account});
      updateAll();
    } catch(e){ console.error(e); alert('Error al usar tickets'); }
  }

  async function placeBid(){
    if(!contract) return;
    try{
      const a = await contract.methods.auction().call();
      const bidAmount = a.currentBid==0 ? web3.utils.toWei('0.001','ether') : BigInt(a.currentBid)+BigInt(web3.utils.toWei('0.001','ether'));
      await contract.methods.bid().send({from:account, value: bidAmount});
      updateAll();
    } catch(e){ console.error(e); alert('Error al pujar'); }
  }

  async function stakeBNB(){
    if(!contract) return;
    const amountInput = document.getElementById('stakeAmount').value;
    if(!amountInput || parseFloat(amountInput)<0.1) return alert('Stake minimo 0.1 BNB');
    const amountWei = web3.utils.toWei(amountInput,'ether');
    try{
      await contract.methods.stake().send({from:account,value:amountWei});
      updateAll();
    } catch(e){ console.error(e); alert('Error al stakear'); }
  }
</script>
</body>
</html>
