<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>SmartStakingBNB PRO Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
<style>
body{margin:0;font-family:Inter,Arial;background:#0b0f14;color:#e5e7eb}
header{padding:20px;background:#111827;display:flex;justify-content:space-between;align-items:center}
button{background:#2563eb;border:none;color:white;padding:10px 16px;border-radius:10px;cursor:pointer;margin-top:6px}
button.secondary{background:#374151}
button:disabled{opacity:.5}
section{padding:20px}
.card{background:#111827;border-radius:18px;padding:20px;margin-bottom:20px;box-shadow:0 0 20px rgba(0,0,0,.45)}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px}
h2{margin-top:0}
.list{max-height:260px;overflow:auto}
.row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #1f2937;font-size:14px}
.rank1{color:#facc15}.rank2{color:#d1d5db}.rank3{color:#c084fc}
.badge{background:#1f2937;border-radius:8px;padding:2px 8px;font-size:12px}
.countdown{font-weight:bold}
.fade{animation:fade .6s}
@keyframes fade{from{opacity:0}to{opacity:1}}
</style>
</head>
<body>
<header>
<h1>SmartStakingBNB PRO</h1>
<div>
<span id="wallet">Not connected</span>
<button id="connectBtn">Connect</button>
</div>
</header>

<section class="grid">
<div class="card">
<h2>üî• Subasta Activa</h2>
<div>Pool: <b><span id="auctionPool">-</span> BNB</b></div>
<div>Puja actual: <b><span id="auctionBid">-</span> BNB</b></div>
<div>Finaliza en: <span id="auctionTimer" class="countdown">-</span></div>
<button onclick="bid()">Pujar + increment</button>
</div>

<div class="card">
<h2>üèÜ Top 10 Pujadores</h2>
<div id="topBidders" class="list"></div>
</div>
</section>

<section class="grid">
<div class="card">
<h2>üéüÔ∏è Rifa Horaria</h2>
<div>Pool: <span id="hourlyPool">-</span> BNB</div>
<div>Tickets vendidos: <span id="hourlyTicketsCount">-</span></div>
<div>Finaliza en: <span id="hourlyTimer" class="countdown">-</span></div>
<input id="hourlyTickets" type="number" placeholder="Tickets" />
<button onclick="enterRaffle(false)">Entrar Horaria</button>
<div class="row">
<button onclick="buyTickets(1,false)">Comprar 1 Ticket</button>
<button onclick="buyTickets(5,false)">Comprar 5 Tickets</button>
<button onclick="buyTickets(10,false)">Comprar 10 Tickets</button>
</div>
<div class="list" id="hourlyPlayers"></div>
</div>

<div class="card">
<h2>üéüÔ∏è Rifa Diaria</h2>
<div>Pool: <span id="dailyPool">-</span> BNB</div>
<div>Tickets vendidos: <span id="dailyTicketsCount">-</span></div>
<div>Finaliza en: <span id="dailyTimer" class="countdown">-</span></div>
<input id="dailyTickets" type="number" placeholder="Tickets" />
<button onclick="enterRaffle(true)">Entrar Diaria</button>
<div class="row">
<button onclick="buyTickets(1,true)">Comprar 1 Ticket</button>
<button onclick="buyTickets(5,true)">Comprar 5 Tickets</button>
<button onclick="buyTickets(10,true)">Comprar 10 Tickets</button>
</div>
<div class="list" id="dailyPlayers"></div>
</div>
</section>

<section class="grid">
<div class="card">
<h2>üíé Staking</h2>
<input type="number" id="stakeAmount" placeholder="BNB a stakear" />
<button onclick="stakeBNB()">Stake</button>
<button onclick="withdrawStake()">Retirar Stake</button>
<div>Staked: <span id="myStaked">0</span> BNB</div>
<div>√öltimo claim: <span id="lastStake">-</span></div>
</div>

<div class="card">
<h2>üë§ Mi Perfil</h2>
<div>Premios totales: <b><span id="myRewards">-</span> BNB</b></div>
<div>Subastas ganadas: <span id="myAuctions">-</span></div>
<div>Rifas ganadas: <span id="myRaffles">-</span></div>
<button class="secondary" onclick="withdraw()">üí∞ Retirar mis premios</button>
</div>
</section>

<section class="grid">
<div class="card">
<h2>üìä Estad√≠sticas Globales</h2>
<div>Total pujas: <span id="totalBids">-</span></div>
<div>Total subastas: <span id="totalAuctions">-</span></div>
<div>Total rifas: <span id="totalRaffles">-</span></div>
<div>Total BNB repartido: <span id="totalBNB">-</span></div>
<canvas id="statsChart" height="120"></canvas>
</div>
</section>

<script defer>
let web3, account, contract;
const CONTRACT_ADDRESS = '0x946409c61E622c6A007D47913C48A2B888F43d7C';
const ABI = [{"inputs":[{"internalType":"address","name":"_treasury","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"pool","type":"uint256"}],"name":"AuctionClosed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint8","name":"rank","type":"uint8"}],"name":"AuctionReward","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BidPlaced","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"bool","name":"daily","type":"bool"},{"indexed":false,"internalType":"uint256","name":"pool","type":"uint256"}],"name":"RaffleClosed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"tickets","type":"uint256"},{"indexed":false,"internalType":"bool","name":"daily","type":"bool"}],"name":"RaffleEntered","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"bool","name":"daily","type":"bool"}],"name":"RaffleReward","type":"event"},{"inputs":[],"name":"AUCTION_INCREMENT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"AUCTION_REWARDS","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"RAFFLE_DAILY_DURATION","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"RAFFLE_HOURLY_DURATION","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"auction","outputs":[{"internalType":"uint256","name":"prizePool","type":"uint256"},{"internalType":"uint256","name":"currentBid","type":"uint256"},{"internalType":"uint256","name":"endTime","type":"uint256"},{"internalType":"bool","name":"active","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"auctionWinners","outputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint8","name":"rank","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"auctionsWon","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"bid","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"closeAuction","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bool","name":"daily","type":"bool"}],"name":"closeRaffle","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"dailyPlayers","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"dailyTickets","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tickets","type":"uint256"},{"internalType":"bool","name":"daily","type":"bool"}],"name":"enterRaffle","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"hourlyPlayers","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"hourlyTickets","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"raffleDaily","outputs":[{"internalType":"bool","name":"daily","type":"bool"},{"internalType":"uint256","name":"prizePool","type":"uint256"},{"internalType":"uint256","name":"endTime","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"raffleDailyWinners","outputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint8","name":"rank","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"raffleHourly","outputs":[{"internalType":"bool","name":"daily","type":"bool"},{"internalType":"uint256","name":"prizePool","type":"uint256"},{"internalType":"uint256","name":"endTime","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"raffleHourlyWinners","outputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint8","name":"rank","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"rafflesWon","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_t","type":"address"}],"name":"setTreasury","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"topBidders","outputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalAuctions","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalBNBRepartido","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalBids","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalRaffles","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"totalUserRewards","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"treasury","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"withdrawTreasury","outputs":[],"stateMutability":"nonpayable","type":"function"}];

document.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('connectBtn').addEventListener('click', connect);
});

async function connect(){
  if(!window.ethereum){alert('Instala Metamask'); return;}
  web3 = new Web3(window.ethereum);
  try{
    const accounts = await window.ethereum.request({ method:'eth_requestAccounts' });
    account = accounts[0];
    document.getElementById('wallet').innerText = account;
    contract = new web3.eth.Contract(ABI, CONTRACT_ADDRESS);
    loadAll(); listenEvents();
  }catch(err){console.error(err); alert('No se pudo conectar con Metamask');}
}

async function bid(){
  const a = await contract.methods.auction().call();
  const inc = await contract.methods.AUCTION_INCREMENT().call();
  const nextBid = web3.utils.toBN(a.currentBid).add(web3.utils.toBN(inc));
  await contract.methods.bid().send({ from: account, value: nextBid });
  loadAuction();
}

async function buyTickets(amount,daily){
  const price = web3.utils.toWei((0.001*amount).toString());
  await contract.methods.enterRaffle(amount,daily).send({ from: account, value: price });
  loadRaffles();
}

async function enterRaffle(daily){
  const t = daily ? document.getElementById('dailyTickets').value : document.getElementById('hourlyTickets').value;
  await buyTickets(t,daily);
}

async function stakeBNB(){
  const val = document.getElementById('stakeAmount').value;
  await contract.methods.stake().send({ from: account, value: web3.utils.toWei(val) });
  loadStaking();
}

async function withdrawStake(){
  await contract.methods.withdraw().send({ from: account });
  loadStaking();
}

async function withdraw(){
  await contract.methods.withdraw().send({ from: account });
  loadProfile();
}

async function loadAll(){
  loadAuction(); loadRaffles(); loadProfile(); loadStats(); loadStaking();
}

async function loadAuction(){
  const a = await contract.methods.auction().call();
  document.getElementById('auctionPool').innerText = web3.utils.fromWei(a.prizePool);
  document.getElementById('auctionBid').innerText = web3.utils.fromWei(a.currentBid);
  timer(a.endTime, document.getElementById('auctionTimer'));

  const topEl = document.getElementById('topBidders');
  topEl.innerHTML='';
  const rewards=[25,18,13,10,8,6,5,4,3,2];
  const poolBNB = web3.utils.fromWei(a.prizePool);
  for(let i=0;i<10;i++){
    try{
      const b = await contract.methods.topBidders(i).call();
      if(b.user==='0x0000000000000000000000000000000000000000') break;
      const prize = (poolBNB*rewards[i]/100).toFixed(4);
      topEl.innerHTML+=`<div class='row rank${i+1} fade'>#${i+1} ${b.user.slice(0,6)}...<span>${web3.utils.fromWei(b.amount)} BNB ¬∑ <span class='badge'>${prize} BNB</span></span></div>`;
    }catch{}
  }
}

async function loadRaffles(){
  const h = await contract.methods.raffleHourly().call();
  document.getElementById('hourlyPool').innerText = web3.utils.fromWei(h.prizePool);
  const d = await contract.methods.raffleDaily().call();
  document.getElementById('dailyPool').innerText = web3.utils.fromWei(d.prizePool);
  timer(h.endTime, document.getElementById('hourlyTimer'));
  timer(d.endTime, document.getElementById('dailyTimer'));
  // Aqu√≠ puedes agregar conteo de tickets vendidos usando totalTicketsVendidos o mapeos de players
}

async function loadStaking(){
  const staked = await contract.methods.stakedBNB(account).call();
  const last = await contract.methods.lastStakeClaim(account).call();
  document.getElementById('myStaked').innerText = web3.utils.fromWei(staked);
  document.getElementById('lastStake').innerText = new Date(last*1000).toLocaleString();
}

async function loadProfile(){
  document.getElementById('myRewards').innerText = web3.utils.fromWei(await contract.methods.totalUserRewards(account).call());
  document.getElementById('myAuctions').innerText = await contract.methods.auctionsWon(account).call();
  document.getElementById('myRaffles').innerText = await contract.methods.rafflesWon(account).call();
}

async function loadStats(){
  const bids = await contract.methods.totalBids().call();
  const auctions = await contract.methods.totalAuctions().call();
  const raffles = await contract.methods.totalRaffles().call();
  const bnb = web3.utils.fromWei(await contract.methods.totalBNBRepartido().call());
  document.getElementById('totalBids').innerText=bids;
  document.getElementById('totalAuctions').innerText=auctions;
  document.getElementById('totalRaffles').innerText=raffles;
  document.getElementById('totalBNB').innerText=bnb;
  new Chart(document.getElementById('statsChart'),{type:'bar',data:{labels:['Bids','Auctions','Raffles'],datasets:[{data:[bids,auctions,raffles]}]}});
}

function timer(end,el){
  const i = setInterval(()=>{
    const s = end - Math.floor(Date.now()/1000);
    if(s<=0){el.innerText='Finalizado';clearInterval(i);return;}
    el.innerText=Math.floor(s/60)+'m '+s%60+'s';
  },1000);
}

function listenEvents(){
  contract.events.BidPlaced().on('data',loadAuction);
  contract.events.AuctionReward().on('data',loadAuction);
  contract.events.RaffleReward().on('data',loadRaffles);
}
</script>
</body>
</html>
